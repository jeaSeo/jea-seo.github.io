<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script src="../js/chartjs/chart.js"></script>
    <script src="../js/danfo0.1.1/index.min.js"></script>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>

    <script>
        $(document).ready(function(){
            $('.slider').slick({
                'infinite': false
            }).on('swipe', function(event, slick, direction){
                
            });
        });
    </script>
</head>
<body>
    <div id="wrap">
        <div class="slider">
            <div class="comp">
                <h4 class="title">문석 모델이다</h4>
                <div>
                    <canvas id="myChart3"></canvas>
                </div>
                <div class="analysis">
                    <h4 class="f1">분석결과</h4>
                    <p id="data3_analysis">
                        당신의 결과는 이러쿵 저러쿵 <em>강조강조</em> 이걸 저렇게 하삼
                    </p>
                </div>
            </div>
            <div class="comp">
                <h4 class="title">문석 모델이다</h4>
                <div>
                    <canvas id="myChart4"></canvas>
                </div>
                <div class="analysis">
                    <h4 class="f1">분석결과</h4>
                    <p id="data4_analysis">
                        당신의 결과는 이러쿵 저러쿵 <em>강조강조</em> 이걸 저렇게 하삼
                    </p>
                </div>
            </div>
            <div class="comp">
                <h4 class="title">문석 모델이다</h4>
                <div>
                    <canvas id="myChart5"></canvas>
                </div>
                <div class="analysis">
                    <h4 class="f1">분석결과</h4>
                    <p id="data5_analysis">
                        당신의 결과는 이러쿵 저러쿵 <em>강조강조</em> 이걸 저렇게 하삼
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
        let lastData, readfile
        if(localStorage.getItem('id')){
            // result1 591250
            // result2 714582
            // result3 803047
            lastData = localStorage.getItem('id')
            readfile =  (Number(lastData)>591250) ? 'result2.csv' : 
            (Number(lastData)>714582) ? 'result3.csv' : 'result1.csv'
        }
        let gbId, gbLabel
        let ar, armax, armin, artitle, arlabel, arcmmtcnt
        let arPositive, arView, arRating
        let arPosKeyword1, arPosKeyword2, arPosKeyword3
        let arNegKeyword1, arNegKeyword2, arNegKeyword3
        let maxindex3, maxindex4, maxindex5
        let minindex3, minindex4, minindex5

        // labels 
        let dataLabel = ['id', 'title', '5th', '10th', 
        'first_positive_5', 'second_view_1','third_rating_people_5', 
        'first_positive_5_1', 'second_view_1_1','third_rating_people_5_1', 
        'first_positive_5_story','second_view_1_story', 'third_rating_people_5_story', 
        'positive','view', 'rating_people', 
        'positive_1', 'view_1', 'rating_people_1',
        'positive_story', 'view_story', 'rating_people_story',
        'comment_writer_count', 'comment_writer', 
        'pos_keyword_1', 'pos_keyword_2', 'pos_keyword_3', 
        'neg_keyword_1', 'neg_keyword_2', 'neg_keyword_3', 'label']

        let userLabel = ['id', 'title', '5회차승격확률', '10회차확률', 
        'first_positive_5', 'second_view_1','third_rating_people_5', 
        'first_positive_5_1', 'second_view_1_1','third_rating_people_5_1', 
        'first_positive_5_story','second_view_1_story', 'third_rating_people_5_story', 
        '긍정댓글수','조회수', '평점참여자', 
        '긍정댓글수 전체평균', '조회수 전체평균', '평점참여자 전체평균',
        'positive_story', 'view_story', 'rating_people_story',
        '댓글수', '댓글작성자', 
        '긍정키워드1', '긍정키워드2', '긍정키워드3', 
        '부정키워드1', '부정키워드2', '부정키워드3', '승격여부']

        const readCsv = (path) => {
            let arcnt = 0
            dfd.read_csv(path)
            .then(df => {
                ar = df.values
                armax = df.max().data
                armin = df.min().data
                arcnt = Array.from({length:ar.length}, (v,i)=>i+1+'회')
                // aridIndex   = arids.indexOf(lastData)
                // aridIndex   = arids.indexOf(15067)
                // eval('gbId_'+ar.at(aridIndex).at(0)+' = df.groupby(["id"]).get_groups(['+ar.at(aridIndex).at(0)+']).values')
                
                arids            = Array.from(ar, x => x.at(0))
                artitle          = Array.from(ar, x => x.at(1))
                promote5         = Math.round(ar.at(0).at(2))
                promote10        = Math.round(ar.at(0).at(3))
                promote5         = Math.ceil(ar.at(0).at(2)*100)
                promote10        = Math.ceil(ar.at(0).at(3)*100)
                arPositive       = Array.from(ar, x => x.at(13))
                arView           = Array.from(ar, x => x.at(14))
                arRating         = Array.from(ar, x => x.at(15))
                arPositiveTotal  = Array.from(ar, x => x.at(16))
                arViewTotal      = Array.from(ar, x => x.at(17))
                arRatingTotal    = Array.from(ar, x => x.at(18))

                for(let j=0;j<ar.length;j++){
                    if (ar.at(j).at(13) === Math.round(armax.at(13) * 100)/100) {
                        maxindex3 = j // max index
                    } 
                    if (ar.at(j).at(14) === Math.round(armax.at(14) * 100)/100){
                        maxindex4 = j // max index
                    }
                    if (ar.at(j).at(15) === Math.round(armax.at(15) * 100)/100){
                        maxindex5 = j // max index
                    }
                    
                    if (ar.at(j).at(13) === Math.round(armin.at(13) * 100)/100) {
                        minindex3 = j // max index
                    } 
                    if (ar.at(j).at(14) === Math.round(armin.at(14) * 100)/100){
                        minindex4 = j // max index
                    }
                    if (ar.at(j).at(15) === Math.round(armin.at(15) * 100)/100){
                        minindex5 = j // max index
                    }
                }
                

                let circleSize = 10
                let pointRadius3 = Array.from({length:ar.length}, (i)=>3)
                let pointRadius4 = Array.from({length:ar.length}, (i)=>3)
                let pointRadius5 = Array.from({length:ar.length}, (i)=>3)
                pointRadius3 = pointRadius3.fill(circleSize,maxindex3,maxindex3+1)
                pointRadius4 = pointRadius4.fill(circleSize,maxindex4,maxindex4+1)
                pointRadius5 = pointRadius5.fill(circleSize,maxindex5,maxindex5+1)

                pointRadius3 = pointRadius3.fill(circleSize,minindex3,minindex3+1)
                pointRadius4 = pointRadius4.fill(circleSize,minindex4,minindex4+1)
                pointRadius5 = pointRadius5.fill(circleSize,minindex5,minindex5+1)
                
                // styling 
                const bgcolor = ['#00800050', '#ff0000','#fff000']
                let bgcolorOpacity3 = Array.from({length:ar.length}, (i)=>bgcolor.at(1))
                bgcolorOpacity3 = bgcolorOpacity3.fill(bgcolor.at(1)+'50',maxindex3,maxindex3+1)
                bgcolorOpacity3 = bgcolorOpacity3.fill(bgcolor.at(1)+'50',minindex3,minindex3+1)
    
                let bgcolorOpacity4 = Array.from({length:ar.length}, (i)=>bgcolor.at(0))
                bgcolorOpacity4 = bgcolorOpacity4.fill(bgcolor.at(0),maxindex4,maxindex4+1)
                bgcolorOpacity4 = bgcolorOpacity4.fill(bgcolor.at(0),minindex4,minindex4+1)

                let bgcolorOpacity5 = Array.from({length:ar.length}, (i)=>bgcolor.at(2))
                bgcolorOpacity5 = bgcolorOpacity5.fill(bgcolor.at(2)+'50',maxindex5,maxindex5+1)
                bgcolorOpacity5 = bgcolorOpacity5.fill(bgcolor.at(2)+'50',minindex5,minindex5+1)
    
                // console.log(pointRadius)
                const ctx3 = document.getElementById('myChart3');
                const ctx4 = document.getElementById('myChart4');
                const ctx5 = document.getElementById('myChart5');

                const data3 = {
                    labels: arcnt,
                    datasets: [
                        {
                            label: userLabel[13],
                            data: arPositive,
                            borderColor: bgcolor.at(1),
                            backgroundColor: bgcolorOpacity3,
                            pointRadius: pointRadius3,
                            pointHoverRadius: 15
                        },
                        {
                            label: userLabel[16],
                            data: arPositiveTotal,
                            borderColor: 'lightgray',
                            backgroundColor: 'lightgray',
                            pointRadius: 2,
                            pointHoverRadius: 15
                        }
                    ]
                }
    
                const data4 = {
                    labels: arcnt,
                    datasets: [
                        {
                            label: userLabel[14],
                            data: arView,
                            borderColor: bgcolor.at(0),
                            backgroundColor: bgcolorOpacity4,
                            pointRadius: pointRadius4,
                            pointHoverRadius: 15
                        },
                        {
                            label: userLabel[17],
                            data: arViewTotal,
                            borderColor: 'lightgray',
                            backgroundColor: 'lightgray',
                            pointRadius: 2,
                            pointHoverRadius: 15
                        }
                    ]
                }
    
                const data5 = {
                    labels: arcnt,
                    datasets: [
                        {
                            label: userLabel[15],
                            data: arRating,
                            borderColor: bgcolor.at(2),
                            backgroundColor: bgcolorOpacity5,
                            pointRadius: pointRadius5,
                            pointHoverRadius: 15
                        },
                        {
                            label: userLabel[18],
                            data: arRatingTotal,
                            borderColor: 'lightgray',
                            backgroundColor: 'lightgray',
                            pointRadius: 1,
                            pointHoverRadius: 15
                        }
                    ]
                }
    
                new Chart(ctx3, {
                    type: 'line',
                    data: data3,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
    
                new Chart(ctx4, {
                    type: 'line',
                    data: data4,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
    
                new Chart(ctx5, {
                    type: 'line',
                    data: data5,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }).then(function(){
                let comment_target = document.getElementById('data3_analysis')
                let comments = ''
                comments += '선택하신 [' + artitle[0] +'] 의 ' + userLabel.at(13) + ', 그리고 ' + userLabel.at(16) + ' 지표를 비교한 결과 '
                if ((((Math.round(armax.at(16)) - Math.round(armax.at(13))) * 100)/100)<0) {
                    comments += '최고 '+ userLabel.at(13) + ' 기준 정식연재된 작품의 같은 회차와 비교해 약 ' + '<em class="' + 'high' + '">' + (((Math.round(armax.at(13)) - Math.round(armax.at(16))) * 100)/100) + '개</em> 높습니다.'
                } else {
                    comments += '최고 '+ userLabel.at(13) + ' 기준 정식연재된 작품의 같은 회차와 비교해 약 ' + '<em class="' + 'low' + '">' + (((Math.round(armax.at(16)) - Math.round(armax.at(13))) * 100)/100) + '개</em> 낮습니다.'
                }
                comment_target.innerHTML = comments
            }).then(function(){
                let comment_target = document.getElementById('data4_analysis')
                let comments = ''
                comments += '선택하신 [' + artitle[0] +'] 의 ' + userLabel.at(14) + ', 그리고 ' + userLabel.at(17) + ' 지표를 분석한 결과 '
                if ((((Math.round(armax.at(17)) - Math.round(armax.at(14))) * 100)/100)<0) {
                    comments += '최고 '+ userLabel.at(14) + ' 기준 정식연재된 작품의 같은 회차와 비교해 약 ' + '<em class="' + 'high' + '">' + (((Math.round(armax.at(14)) - Math.round(armax.at(17))) * 100)/100) + '회</em> 높습니다.'
                } else {
                    comments += '최고 '+ userLabel.at(14) + ' 기준 정식연재된 작품의 같은 회차와 비교해 약 ' + '<em class="' + 'low' + '">' + (((Math.round(armax.at(17)) - Math.round(armax.at(14))) * 100)/100) + '회</em> 낮습니다.'
                }
                comment_target.innerHTML = comments
            }).then(function(){
                let comment_target = document.getElementById('data5_analysis')
                let comments = ''
                comments += '선택하신 [' + artitle[0] +'] 의 ' + userLabel.at(15) + ', 그리고 ' + userLabel.at(18) + ' 지표를 분석한 결과 '
                if ((((Math.round(armax.at(18)) - Math.round(armax.at(15))) * 100)/100)<0) {
                    comments += '최고 '+ userLabel.at(15) + ' 기준 정식연재된 작품의 같은 회차와 비교해 약 ' + '<em class="' + 'high' + '">' + (((Math.round(armax.at(15)) - Math.round(armax.at(18))) * 100)/100) + '명</em> 높습니다.'
                } else {
                    comments += '최고 '+ userLabel.at(15) + ' 기준 정식연재된 작품의 같은 회차와 비교해 약 ' + '<em class="' + 'low' + '">' + (((Math.round(armax.at(18)) - Math.round(armax.at(15))) * 100)/100) + '명</em> 낮습니다.'
                }
                comment_target.innerHTML = comments
            }).catch(err => {
                console.log(err);
            })
        }
        readCsv("../data/total/" + readfile)
        localStorage.setItem('id',lastData)
        console.log('현재 실행 중 파일은 '+readfile+'이고 아이디는 '+lastData+'입니다.')
    </script>
</body>
</html>