<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script src="../js/chartjs/chart.js"></script>
    <script src="../js/danfo0.1.1/index.min.js"></script>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script>
        $(document).ready(function(){
            $('.slider').slick({
                'infinite': false
            }).on('swipe', function(event, slick, direction){
                
            });
        });
    </script>
</head>
<body>
    <div id="wrap">
        <div class="summary_wrap">
            <div class="summary_part">
                <div class="summary_title">
                    <!-- <div id="wtthumb"></div> -->
                    <h3 class="title"><em id="wttitle"></em>의 정식연재 확률은?<br /></h3>
                    <em id="promote"></em>
                    <div class="sub">2022년 12월 기준</div>
                </div>
                <ul class="summary_list">
                    <li class="item">
                        <div id="part1" class="part"></div>
                        <div>
                            <span id="score1"></span>
                            <span id="state1"></span>
                        </div>
                    </li>
                    <li class="item">
                        <div id="part2" class="part"></div>
                        <div>
                            <span id="score2"></span>
                            <span id="state2"></span>
                        </div>
                    </li>
                    <li class="item">
                        <div id="part3" class="part"></div>
                        <div>
                            <span id="score3"></span>
                            <span id="state3"></span>
                        </div>
                    </li>
                </ul>
                <div class="more">
                    <a href="detail.html" class="item_anchor">차트로 비교해 보기</a>
                </div>
            </div>

            <div class="mean_compare">
                <div class="title_area">
                    <h3>내 작품과 조건 별 전체 평균 비교</h3>
                </div>
                <div class="slider">
                    <div class="chart_item"><canvas id="myChart1"></canvas></div>
                    <div class="chart_item"><canvas id="myChart2"></canvas></div>
                    <div class="chart_item"><canvas id="myChart3"></canvas></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let lastData
        if(localStorage.getItem('id')){
            lastData = localStorage.getItem('id')
        }
        let gbId, gbLabel
        let ar, armax, armin, artitle, arlabel, arcmmtcnt, promote5, promote10
        let arPositive, arView, arRating
        let first_positive_5, second_view_1, third_rating_people_5
        let first_positive_5_1, second_view_1_1, third_rating_people_5_1
        let first_positive_5_genre, second_view_1_genre, third_rating_people_5_genre
        let arPositiveTotal, arViewTotal, arRatingTotal
        let arPosKeyword1, arPosKeyword2, arPosKeyword3
        let arNegKeyword1, arNegKeyword2, arNegKeyword3
        let maxindex3, maxindex4, maxindex5
        let minindex3, minindex4, minindex5
        // labels 
        let dataLabel = ['id', 'title', '5th', '10th', 
        'first_positive_5', 'second_view_1','third_rating_people_5', 
        'first_positive_5_1', 'second_view_1_1','third_rating_people_5_1', 
        'first_positive_5_story','second_view_1_story', 'third_rating_people_5_story', 
        'positive','view', 'rating_people', 
        'positive_1', 'view_1', 'rating_people_1',
        'positive_story', 'view_story', 'rating_people_story',
        'comment_writer_count', 'comment_writer', 
        'pos_keyword_1', 'pos_keyword_2', 'pos_keyword_3', 
        'neg_keyword_1', 'neg_keyword_2', 'neg_keyword_3', 'label']
        let userLabel = ['id', 'title', '5회차승격확률', '10회차확률', 
        '5회의 긍정댓글 수', '1회의 조회수','5회의 평가자 수', 
        '5회의 긍정댓글 수 전체평균', '1회의 조회수 전체평균','5회의 평가자 수 전체평균', 
        '5회의 긍정댓글 수 장르평균','1회의 조회수 장르평균', '5회의 평가자 수 장르평균', 
        '긍정댓글수','조회수', '평점참여자', 
        '긍정댓글수 전체평균', '조회수 전체평균', '평점참여자 전체평균',
        'positive_story', 'view_story', 'rating_people_story',
        '댓글수', '댓글작성자', 
        '긍정키워드1', '긍정키워드2', '긍정키워드3', 
        '부정키워드1', '부정키워드2', '부정키워드3', '승격여부']

        let userlabelforchart = [
            ['5회차의 긍정적인 댓글 수'], ['1회차의 조회수'], ['5회차의 평가자 수'], 
            ['5회차의 긍정적인 댓글 수 전체평균'], ['1회차의 조회수 전체평균'], ['5회차의 평가자 수 전체평균'], 
            ['5회차의 동일 전개방식의 정식연재 성공작 평균 긍정적인 댓글 수'], ['1회차의 동일 전개방식의 정식연재 성공작 평균 조회수'], ['5회차의 동일 전개방식의 정식연재 성공작 평균 평가자 수']
        ]

        const readCsv = (path) => {
            let arcnt = 0
            dfd.read_csv(path)
            .then(df => {
                ar = df.values
                armax = df.max().data
                armin = df.min().data
                arcnt = Array.from({length:ar.length}, (v,i)=>i+1+'회')
                // aridIndex   = arids.indexOf(lastData)
                // aridIndex   = arids.indexOf(15067)
                // eval('gbId_'+ar.at(aridIndex).at(0)+' = df.groupby(["id"]).get_groups(['+ar.at(aridIndex).at(0)+']).values')
                
                arids                         = Array.from(ar, x => x.at(0))
                artitle                       = Array.from(ar, x => x.at(1))
                promote5                      = Math.round(ar.at(0).at(2))
                promote10                     = Math.round(ar.at(0).at(3))
                promote5                      = Math.ceil(ar.at(0).at(2)*100)
                promote10                     = Math.ceil(ar.at(0).at(3)*100)
                first_positive_5              = ar.at(0).at(4)
                second_view_1                 = ar.at(0).at(5)
                third_rating_people_5         = ar.at(0).at(6)
                first_positive_5_1            = Math.ceil(ar.at(0).at(7))
                second_view_1_1               = Math.ceil(ar.at(0).at(8))
                third_rating_people_5_1       = Math.ceil(ar.at(0).at(9))
                first_positive_5_genre        = Math.ceil(ar.at(0).at(10))
                second_view_1_genre           = Math.ceil(ar.at(0).at(11))
                third_rating_people_5_genre   = Math.ceil(ar.at(0).at(12))
                arPositive                    = Array.from(ar, x => x.at(13))
                arView                        = Array.from(ar, x => x.at(14))
                arRating                      = Array.from(ar, x => x.at(15))
                arPositiveTotal               = Array.from(ar, x => x.at(16))
                arViewTotal                   = Array.from(ar, x => x.at(17))
                arRatingTotal                 = Array.from(ar, x => x.at(18))

                console.log(first_positive_5)
                console.log(first_positive_5_1)
                console.log(first_positive_5_genre)

                for(let j=0;j<ar.length;j++){
                    if (ar.at(j).at(13) === Math.round(armax.at(13) * 100)/100) {
                        maxindex3 = j // max index
                    } 
                    if (ar.at(j).at(14) === Math.round(armax.at(14) * 100)/100){
                        maxindex4 = j // max index
                    }
                    if (ar.at(j).at(15) === Math.round(armax.at(15) * 100)/100){
                        maxindex5 = j // max index
                    }
                    
                    if (ar.at(j).at(13) === Math.round(armin.at(13) * 100)/100) {
                        minindex3 = j // max index
                    } 
                    if (ar.at(j).at(14) === Math.round(armin.at(14) * 100)/100){
                        minindex4 = j // max index
                    }
                    if (ar.at(j).at(15) === Math.round(armin.at(15) * 100)/100){
                        minindex5 = j // max index
                    }
                }
                
            }).then(function(){
                let comment_target1 = document.getElementById('promote')
                let comment_target2 = document.getElementById('wttitle')
                let comments1 = promote5 + '%'
                let comments2 = artitle.at(0)
                comment_target1.innerHTML = comments1
                comment_target2.innerHTML = comments2
            }).then(function(){
                let comment_target1 = document.getElementById('score1')
                let comment_target2 = document.getElementById('state1')
                let comment_target3 = document.getElementById('part1')
                let comments1 = ''
                let comments2 = ''
                let comments3 = userLabel.at(13)
                if ((((Math.round(armax.at(16)) - Math.round(armax.at(13))) * 100)/100)<0) {
                    comments1 += (((Math.round(armax.at(13)) - Math.round(armax.at(16))) * 100)/100)
                    comments2 += '개 <em class="high">높음</em>'
                } else {
                    comments1 += (((Math.round(armax.at(16)) - Math.round(armax.at(13))) * 100)/100)
                    comments2 += '개 <em class="low">낮음</em>'
                }
                comment_target1.innerHTML = comments1
                comment_target2.innerHTML = comments2
                comment_target3.innerHTML = comments3
            }).then(function(){
                let comment_target1 = document.getElementById('score2')
                let comment_target2 = document.getElementById('state2')
                let comment_target3 = document.getElementById('part2')
                let comments1 = ''
                let comments2 = ''
                let comments3 = userLabel.at(14)
                if ((((Math.round(armax.at(17)) - Math.round(armax.at(14))) * 100)/100)<0) {
                    comments1 += (((Math.round(armax.at(14)) - Math.round(armax.at(17))) * 100)/100)
                    comments2 += '회 <em class="high">높음</em>'
                } else {
                    comments1 += (((Math.round(armax.at(17)) - Math.round(armax.at(14))) * 100)/100)
                    comments2 += '회 <em class="low">낮음</em>'
                }
                comment_target1.innerHTML = comments1
                comment_target2.innerHTML = comments2
                comment_target3.innerHTML = comments3
            }).then(function(){
                let comment_target1 = document.getElementById('score3')
                let comment_target2 = document.getElementById('state3')
                let comment_target3 = document.getElementById('part3')
                let comments1 = ''
                let comments2 = ''
                let comments3 = userLabel.at(15)
                if ((((Math.round(armax.at(18)) - Math.round(armax.at(15))) * 100)/100)<0) {
                    comments1 += (((Math.round(armax.at(15)) - Math.round(armax.at(18))) * 100)/100)
                    comments2 += '명 <em class="high">높음</em>'
                } else {
                    comments1 += (((Math.round(armax.at(18)) - Math.round(armax.at(15))) * 100)/100)
                    comments2 += '명 <em class="low">낮음</em>'
                }
                comment_target1.innerHTML = comments1
                comment_target2.innerHTML = comments2
                comment_target3.innerHTML = comments3
            
            }).then(function() {
                
                let circleSize = 10
                let pointRadius3 = Array.from({length:ar.length}, (i)=>3)
                let pointRadius4 = Array.from({length:ar.length}, (i)=>3)
                let pointRadius5 = Array.from({length:ar.length}, (i)=>3)
                pointRadius3 = pointRadius3.fill(circleSize,maxindex3,maxindex3+1)
                pointRadius4 = pointRadius4.fill(circleSize,maxindex4,maxindex4+1)
                pointRadius5 = pointRadius5.fill(circleSize,maxindex5,maxindex5+1)

                pointRadius3 = pointRadius3.fill(circleSize,minindex3,minindex3+1)
                pointRadius4 = pointRadius4.fill(circleSize,minindex4,minindex4+1)
                pointRadius5 = pointRadius5.fill(circleSize,minindex5,minindex5+1)
                
                // styling 
                const bgcolor = ['#00800050', '#ff0000','#fff000']
                let bgcolorOpacity3 = Array.from({length:ar.length}, (i)=>bgcolor.at(1))
                bgcolorOpacity3 = bgcolorOpacity3.fill(bgcolor.at(1)+'50',maxindex3,maxindex3+1)
                bgcolorOpacity3 = bgcolorOpacity3.fill(bgcolor.at(1)+'50',minindex3,minindex3+1)
    
                let bgcolorOpacity4 = Array.from({length:ar.length}, (i)=>bgcolor.at(0))
                bgcolorOpacity4 = bgcolorOpacity4.fill(bgcolor.at(0),maxindex4,maxindex4+1)
                bgcolorOpacity4 = bgcolorOpacity4.fill(bgcolor.at(0),minindex4,minindex4+1)

                let bgcolorOpacity5 = Array.from({length:ar.length}, (i)=>bgcolor.at(2))
                bgcolorOpacity5 = bgcolorOpacity5.fill(bgcolor.at(2)+'50',maxindex5,maxindex5+1)
                bgcolorOpacity5 = bgcolorOpacity5.fill(bgcolor.at(2)+'50',minindex5,minindex5+1)

                // console.log(pointRadius3)
                const ctx1 = document.getElementById('myChart1');
                const ctx2 = document.getElementById('myChart2');
                const ctx3 = document.getElementById('myChart3');

                const data1 = {
                    labels: [userLabel[4],userLabel[7],userLabel[10]],
                    datasets: [
                        {
                            data: [first_positive_5, first_positive_5_1, first_positive_5_genre],
                            borderColor: bgcolor.at(1),
                            backgroundColor: bgcolorOpacity3,
                            pointRadius: pointRadius3,
                            pointHoverRadius: 15
                        }
                    ]
                }
                console.log(first_positive_5_1)

                const data2 = {
                    labels: [userLabel[5],userLabel[8],userLabel[11]],
                    datasets: [
                        {
                            data: [second_view_1, second_view_1_1, second_view_1_genre],
                            borderColor: bgcolor.at(0),
                            backgroundColor: bgcolorOpacity4,
                            pointRadius: pointRadius4,
                            pointHoverRadius: 15
                        },
                    ]
                }

                const data3 = {
                    labels: [userLabel[6],userLabel[9],userLabel[12]],
                    datasets: [
                        {
                            data: [third_rating_people_5, third_rating_people_5_1, third_rating_people_5_genre],
                            borderColor: bgcolor.at(0),
                            backgroundColor: bgcolorOpacity4,
                            pointRadius: pointRadius4,
                            pointHoverRadius: 15
                        },
                    ]
                }

                new Chart(ctx1, {
                    type: 'bar',
                    data: data1,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                new Chart(ctx2, {
                    type: 'bar',
                    data: data2,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                new Chart(ctx3, {
                    type: 'bar',
                    data: data3,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

            }).catch(err => {
                console.log(err);
            })
        }
        readCsv("../data/total/id_"+lastData+'.csv')
        localStorage.setItem('id',lastData)
        console.log('현재 실행 중 파일은 '+'id_'+lastData+'csv'+'입니다.')
    </script>
</body>
</html>